<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Time Trace</title>

    <style>
        canvas {
            background: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            height: 80vmin;
        }
    </style>
</head>

<body>
    <!--<div id="container">
        <video autoplay="true" id="videoElement">
        </video>
    </div>-->
    <canvas id="myCanvas"></canvas>
    <script>

        var VIDEO = null;
        var SIZEX = 640;
        var SIZEY = 480;
        var CANVAS;
        var LASTFRAME;

        function main() {

            initializeCamera();

            CANVAS = initializeCanvas("myCanvas", SIZEX, SIZEY);

            var ctx = CANVAS.getContext("2d");

            setInterval(function () {
                drawScene(ctx);
            }, 1);  // once every 100 ms
        }


        function initializeCanvas(canvasName, width, height) {
            let canvas = document.getElementById(canvasName);
            canvas.width = width;
            canvas.height = height;
            return canvas;
        }

        function drawScene(ctx) {
            if (VIDEO != null) {
                var min = Math.min(VIDEO.videoWidth, VIDEO.videoHeight);
                var sx = (VIDEO.videoWidth - min) / 2;
                var sy = (VIDEO.videoHeight - min) / 2;
                console.log(VIDEO.videoWidth + " " + VIDEO.videoHeight);
                ctx.drawImage(VIDEO, 0, 0);// sx, sy, min, min, 0, 0, SIZEX, SIZEY);
                timeTrace(ctx);
            }

        }

        function timeTrace(ctx) {
            var imgData = ctx.getImageData(0, 0, SIZEX, SIZEY);
            if (LASTFRAME == null) LASTFRAME = imgData.data.slice();
            var data = imgData.data;
            var colwidth = 1;
            for (var y = 0; y < SIZEY; y++) {
                for (var i = 1; i <= colwidth; i++) {
                    data[(y * SIZEX + SIZEX - i) * 4 + 0] = data[(y * SIZEX + SIZEX / 2 - i) * 4 + 0];
                    data[(y * SIZEX + SIZEX - i) * 4 + 1] = data[(y * SIZEX + SIZEX / 2 - i) * 4 + 1];
                    data[(y * SIZEX + SIZEX - i) * 4 + 2] = data[(y * SIZEX + SIZEX / 2 - i) * 4 + 2];
                }

            }

            for (var x = 0; x < SIZEX - colwidth; x += colwidth) {
                for (var y = 0; y < SIZEY; y++) {
                    for (var i = 0; i < colwidth; i++) {
                        data[(y * SIZEX + x + i) * 4 + 0] = LASTFRAME[((y) * SIZEX + x + colwidth + i) * 4 + 0];
                        data[(y * SIZEX + x + i) * 4 + 1] = LASTFRAME[((y) * SIZEX + x + colwidth + i) * 4 + 1];
                        data[(y * SIZEX + x + i) * 4 + 2] = LASTFRAME[((y) * SIZEX + x + colwidth + i) * 4 + 2];
                    }
                }
            }
            ctx.putImageData(imgData, 0, 0)
            LASTFRAME = imgData.data.slice();
        }


        function initializeCamera() {
            var promise = navigator.mediaDevices.getUserMedia({ video: true });
            promise.then(function (signal) {
                VIDEO = document.createElement("video");
                VIDEO.srcObject = signal;
                VIDEO.play();

            }).catch(function (err) {
                alert("Camera Error");
            });
        }

        main();
    </script>
</body>
</html>